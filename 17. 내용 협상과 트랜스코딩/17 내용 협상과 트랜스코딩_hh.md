### 내용 협상 기법

- 서버에 있는 페이지들 중 어떤 것이 클라이언트에게 맞는지 판단하는 세 가지 다른 방법이 있음.
    - 클라이언트 주도 협상
    - 서버 주도 협상
    - 투명한 협상

### 클라이언트 주도 협상

- 서버에게 가장 쉬운 방법은 서버가 클라이언트의 요청을 받았을 때 가능한 페이지의 목록을 응답을 돌려주어 클라이언트가 보고 싶은 것을 선택하게 하는 것.
    - 단점으로는 각 페이지에 두 번의 요청이 필요하고, 느리고 지루한 과정임.
- 서버는 클라이언트에게 여러가지 버전에 대한 링크와 설명이 담긴 HTML 페이지를 돌려주거나, 300Multiple Choices 응답 코드로 HTTP/1.1응답을 돌려줌.
    - 단점으로는 대기시간이 증가되고, 페이지당 여러 번의 요청이 필요함.

### 서버 주도 협상

- 클라이언트가 서버가 결정을 하도록 요청 헤더에 정보를 삽입함.
- 서버가 클라이언트의 요청 헤더를 검증해서 어떤 버전을 제공할지 결정함.
    - 내용 협상 헤더에서 서버는 클라이언트의 Accept 관련 헤더들을 보고 그에 알맞은 응답을 돌려줌.
    - 내용 협상 헤더 이외의 다른 헤더에서 서버는 클라이언트의 User-Agent헤더에 기반하여 응답을 돌려줌.
- 내용 협상 헤더
    - HTTP 헤더들을 이용해서 자신의 선호 정보를 보낼 수 있음.
        - Accept : 서버가 어떤 미디어 타입으로 보내도 되는지 알려줌.
        - Accept-Language : 서버가 어떤 언어로 보내도 되는지 알려줌.
        - Accept-Charset : 서버가 어떤 차셋으로 보내도 되는지 알려줌.
        - Accept-Encoding : 서버가 어떤 인코딩으로 보내도 되는지 알려줌.
    - HTTP는 상태가 없는 프로토콜이기 때문에 클라이언트는 자신의 선호 정보를 매 요청마다 보내야함.
- 내용 협상 헤더의 품질값
    - HTTP 프로토콜은 클라이언트가 각 선호의 카테고리마다 여러 선택 가능한 항목을 선호도와 함께 나열할 수 있도록 품질값을 정의함.
    - `Accept-Language: en;q=0.5, fr;q=0.0 nl;q=1.0, tr;q=0.0`
        - q값은 0.0부터 1.0까지의 값을 가지며 0.0은 가장 낮은 선호도 1.0은 가장 높은 선호도임.
        - 네덜란드어(nl)를 가장 선호하며 어떤 경우에는 영어도 선호함.
        - 어떤 경우라도 프랑스어나 터키어 버전은 원하지 않는다는 것을 알 수 있음.

### 투명 협상

- 클라이언트 입장에서 협상하는 중개자 프락시를 둚으로써, 클라이언트와의 메시지 교환을 최소화 하며 서버 주도 협상으로 인한 부하를 서버에서 제거함.
- 서버는 응답에 Vary 헤더를 포함시켜 보냄으로써 중개자에게 내용 협상을 위해 어떤 헤더를 사용하고 있는지 알려줄 수 있음.
- 캐시 프락시는 단일한 URL을 통해 접근할 수 있는 문서의 여러 다른 사본을 저장할 수 있음.
- 캐시와 얼터네이트(alternate)
    - 캐시는 클라이언트에게 올바르게 응답을 돌려주기 위해, 서버가 응답을 돌려줄 때 사용했던 로직을 상당부분 사용함.
    - 캐시는 반드시 모든 요청을 서버에게 전달하고 모든 응답을 저장해야함.
    - 캐시는 같은 URL에 대해 두 개의 다른 문서를 갖게 됨.
    - 이 다른 버전은 배리언트(variant)나 얼터네이트(alternate)라고 불림.
- Vary 헤더
    - HTTP Vary 응답 헤더는 서버가 문서를 선택하거나 커스텀 콘텐츠를 생성할 때 고려한 클라이언트 요청 헤더 모두(일반적인 내용 협상 헤더 외에 추가로 더해서)를 나열함.
    - 캐시가 문서를 클라이언트에게 제공해 주기 전에, 캐시는 반드시 캐시된 응답 안에 서버가 보낸 Vary 헤더가 있는지 확인해야 함.
    - Vary 헤더가 존재한다면, Vary 헤더가 명시하고 있는 헤더들은 새 요청과 오래되고 캐시된 요청의 값이 맞아야 함.
    - 투명 협상을 구현하기 위해 캐시는 반드시 캐시된 배리언트와 함께 클라이언트 요청 헤더와 그에 알맞은 서버 응답 헤더 양쪽 모두를 저장해야 함.

### 트랜스 코딩

- 서버가 클라이언트의 요구에 맞는 문서를 가지고 있지 않다면, 서버는 기존의 문서를 클라이언트가 사용할 수 있는 무언가로 변환 할 수 있으며, 이 옵션을 트랜스코딩이라 부름.
- 트랜스코딩에는 포맷 변환, 정보 합성, 내용 주입의 세 종류가 있음.
- 포맷 변환 : 데이터를 클라이언트가 볼 수 있도록 한 포맷에서 다른 포맷으로 변환하는 것.
- 정보 합성
    - 문서에서 정보의 요점을 추출하는 것. ex) 책 각 절의 제목에 기반한 문서의 개요 생성이나 페이지에서 광고 및 로고 제거
    - 웹페이지 디렉토리와 같은 자동화된 웹페이지 분류 시스템에 의해 종종 사용됨.
